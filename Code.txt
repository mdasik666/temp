import React, { useEffect, useRef, useState } from 'react';
import * as pdfjsLib from 'pdfjs-dist';
import 'pdfjs-dist/web/pdf_viewer.css'; // Optional for default styling

const PdfComparison = ({ pdf1Url, pdf2Url }) => {
  const canvas1Ref = useRef(null);
  const canvas2Ref = useRef(null);
  const [pageNumber, setPageNumber] = useState(1);

  const renderPage = async (pdf, canvasRef, pageNum) => {
    const page = await pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1 });
    const canvas = canvasRef.current;
    const context = canvas.getContext('2d');
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    const renderContext = {
      canvasContext: context,
      viewport,
    };
    await page.render(renderContext).promise;
  };

  const loadPdf = async (url, canvasRef) => {
    const loadingTask = pdfjsLib.getDocument(url);
    const pdf = await loadingTask.promise;
    return pdf;
  };

  useEffect(() => {
    let pdf1, pdf2;

    (async () => {
      pdf1 = await loadPdf(pdf1Url, canvas1Ref);
      pdf2 = await loadPdf(pdf2Url, canvas2Ref);

      renderPage(pdf1, canvas1Ref, pageNumber);
      renderPage(pdf2, canvas2Ref, pageNumber);
    })();

    return () => {
      pdf1?.destroy();
      pdf2?.destroy();
    };
  }, [pdf1Url, pdf2Url, pageNumber]);

  const nextPage = () => setPageNumber((prev) => prev + 1);
  const prevPage = () => setPageNumber((prev) => Math.max(prev - 1, 1));

  return (
    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
      <canvas ref={canvas1Ref}></canvas>
      <canvas ref={canvas2Ref}></canvas>
      <div style={{ marginTop: '20px' }}>
        <button onClick={prevPage}>Previous Page</button>
        <button onClick={nextPage}>Next Page</button>
      </div>
    </div>
  );
};

export default PdfComparison;


const highlightDifferences = async (pdf1, pdf2, canvasRef1, canvasRef2, pageNum) => {
  const page1 = await pdf1.getPage(pageNum);
  const page2 = await pdf2.getPage(pageNum);

  const textContent1 = await page1.getTextContent();
  const textContent2 = await page2.getTextContent();

  const canvas1 = canvasRef1.current;
  const canvas2 = canvasRef2.current;
  const ctx1 = canvas1.getContext('2d');
  const ctx2 = canvas2.getContext('2d');

  // Compare textContent1 and textContent2 and highlight differences
  // Example: If textContent1.items[x].str !== textContent2.items[x].str
  textContent1.items.forEach((item, index) => {
    if (textContent2.items[index] && item.str !== textContent2.items[index].str) {
      const { x, y, width, height } = item.transform;
      ctx1.fillStyle = 'rgba(255, 0, 0, 0.5)';
      ctx1.fillRect(x, y - height, width, height);
      ctx2.fillStyle = 'rgba(255, 0, 0, 0.5)';
      ctx2.fillRect(x, y - height, width, height);
    }
  });
};
